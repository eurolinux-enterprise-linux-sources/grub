From 7e22ace25a2007a329c6af46d24dea8d54529834 Mon Sep 17 00:00:00 2001
From: Takayuki Nagata <tnagata@redhat.com>
Date: Tue, 23 Feb 2016 15:11:04 +0100
Subject: [PATCH 1/1] Fix huge loading times of fragmented initramfs when on
 EXT4 filesystem

---
 stage2/fsys_ext2fs.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/stage2/fsys_ext2fs.c b/stage2/fsys_ext2fs.c
index 01386d1..ad5450f 100644
--- a/stage2/fsys_ext2fs.c
+++ b/stage2/fsys_ext2fs.c
@@ -23,6 +23,7 @@
 #include "filesys.h"
 
 static int mapblock1, mapblock2;
+static int last_leaf_lo;
 
 /* sizes are always in bytes, BLOCK values are always in DEV_BSIZE (sectors) */
 #define DEV_BSIZE get_sector_size(current_drive)
@@ -632,11 +633,12 @@ ext4fs_block_map (int logical_block)
 	  errnum = ERR_FILELENGTH;
 	  return -1;
 	}
-	  if (!ext2_rdfsb(ei->ei_leaf_lo, DATABLOCK1))
+	  if (last_leaf_lo != ei->ei_leaf_lo && !ext2_rdfsb(ei->ei_leaf_lo, DATABLOCK1))
 	{
 	  errnum = ERR_FSYS_CORRUPT;
 	  return -1;
 	}
+	  last_leaf_lo = ei->ei_leaf_lo;
 	  eh = (struct ext4_extent_header*)DATABLOCK1;
   	}
 
-- 
2.4.3

